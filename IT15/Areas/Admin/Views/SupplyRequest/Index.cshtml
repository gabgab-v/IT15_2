@model IEnumerable<IT15.Models.SupplyRequest>
@using IT15.Models
@using System.Linq

@{
    ViewData["Title"] = "Supply Requests";
    var statusFilter = ViewData["StatusFilter"] as string;
    string GetStatusBadgeClass(SupplyRequestStatus status) => status switch
    {
        SupplyRequestStatus.Approved => "bg-green-100 text-green-800",
        SupplyRequestStatus.Pending => "bg-yellow-100 text-yellow-800",
        SupplyRequestStatus.Denied => "bg-red-100 text-red-800",
        _ => "bg-gray-100 text-gray-800"
    };
}

<div class="space-y-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-900">Supply Requests</h2>
        <p class="mt-1 text-sm text-gray-600">Review and action supply requests before supplies are added to inventory.</p>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="rounded-md bg-green-50 border border-green-200 px-4 py-3 text-green-800">
            @TempData["SuccessMessage"]
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="rounded-md bg-red-50 border border-red-200 px-4 py-3 text-red-800">
            @TempData["ErrorMessage"]
        </div>
    }

    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <form class="flex items-center space-x-3">
                <label for="statusFilter" class="text-sm font-medium text-gray-700">Status</label>
                <select id="statusFilter"
                        name="statusFilter"
                        onchange="this.form.submit()"
                        class="block w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All</option>
                    @foreach (var statusItem in Html.GetEnumSelectList<SupplyRequestStatus>())
                    {
                        var selectedValue = statusItem.Value == statusFilter ? "selected" : null;
                        <option value="@statusItem.Value" selected="@selectedValue">
                            @statusItem.Text
                        </option>
                    }
                </select>
            </form>
            <span class="text-sm text-gray-500">@Model.Count() request(s) found</span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supply</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Delivery</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Cost</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 relative text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200 text-sm">
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="8" class="px-6 py-6 text-center text-gray-500">
                                No supply requests found.
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var request in Model)
                        {
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900">
                                    @request.DateRequested.ToLocalTime().ToString("MMM dd, yyyy hh:mm tt")
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-700">
                                    @request.RequestingEmployee?.Email ?? "Unknown"
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900">
                                    <div class="font-medium">@request.Supply?.Name ?? "Unknown"</div>
                                    <div class="text-xs text-gray-500">@request.Supply?.Supplier?.Name</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900">
                                    @request.Quantity
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900">
                                    @if (request.DeliveryService != null)
                                    {
                                        <span>@request.DeliveryService.Name</span>
                                        <span class="block text-xs text-gray-500">@request.DeliveryService.Fee.ToString("C")</span>
                                    }
                                    else
                                    {
                                        <span class="text-gray-500">N/A</span>
                                    }
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900">
                                    @request.TotalCost.ToString("C")
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold @GetStatusBadgeClass(request.Status)">
                                        @request.Status
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right space-x-2">
                                    @if (request.Status == SupplyRequestStatus.Pending)
                                    {
                                        <form asp-area="Admin"
                                              asp-controller="SupplyRequest"
                                              asp-action="Approve"
                                              asp-route-id="@request.Id"
                                              method="post"
                                              class="inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="inline-flex items-center px-4 py-2 text-xs font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                                Approve
                                            </button>
                                        </form>
                                        <form asp-area="Admin"
                                              asp-controller="SupplyRequest"
                                              asp-action="Deny"
                                              asp-route-id="@request.Id"
                                              method="post"
                                              class="inline ml-2">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="inline-flex items-center px-4 py-2 text-xs font-semibold text-white bg-red-600 hover:bg-red-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                Deny
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <span class="text-xs text-gray-500">No actions available</span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
